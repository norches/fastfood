version: "3.8"

services:
  db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    volumes:
      - ./.data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - backend

  db-init:
    image: postgres:16
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DB_NAME: ${DB_NAME:-e_food}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
    command:
      - sh
      - -c
      - |
        set -euo pipefail
        if ! echo "${DB_NAME}" | grep -Eq '^[A-Za-z0-9_-]+$'; then
          echo "DB_NAME contains unsupported characters: '${DB_NAME}'" >&2
          echo "Allowed: letters, numbers, underscore, hyphen." >&2
          exit 2
        fi
        export PGPASSWORD="${DB_PASSWORD}"
        echo "Ensuring database '${DB_NAME}' exists..."
        exists=$(psql -h db -U "${DB_USER}" -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='${DB_NAME}'" || true)
        if [ "$exists" = "1" ]; then
          echo "Database '${DB_NAME}' already exists."
          exit 0
        fi
        psql -h db -U "${DB_USER}" -d postgres -v ON_ERROR_STOP=1 -c "CREATE DATABASE \"${DB_NAME}\";"
        echo "Database '${DB_NAME}' created."
    networks:
      - backend

  pgadmin:
    image: dpage/pgadmin4:8.13
    restart: unless-stopped
    depends_on:
      db:
        condition: service_started
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-secret}
      VIRTUAL_HOST: ${PGADMIN_DOMAIN:?set PGADMIN_DOMAIN}
      LETSENCRYPT_HOST: ${PGADMIN_DOMAIN:?set PGADMIN_DOMAIN}
      VIRTUAL_PORT: 80
    volumes:
      - ./.data/pgadmin:/var/lib/pgadmin
    networks:
      - backend
      - proxy-tier

  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: backend-runtime
    image: fastfood-backend
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    environment:
      APP_NAME: ${APP_NAME_BACKEND:-backend}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/${DB_NAME:-e_food}
      SPRING_DATASOURCE_USERNAME: ${DB_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-postgres}
      UPLOAD_DIR: ${UPLOAD_DIR:-files/img}
      APP_CORS_ALLOWED_ORIGIN_PATTERNS: ${APP_CORS_ALLOWED_ORIGIN_PATTERNS:-*}
      VIRTUAL_HOST: ${BACKEND_DOMAIN:?set BACKEND_DOMAIN}
      LETSENCRYPT_HOST: ${BACKEND_DOMAIN:?set BACKEND_DOMAIN}
      VIRTUAL_PORT: 8080
    volumes:
      - ./backend/files/img:/app/files/img
    networks:
      - backend
      - proxy-tier

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: frontend-runtime
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-https://${BACKEND_DOMAIN}}
    image: fastfood-frontend
    restart: unless-stopped
    environment:
      VIRTUAL_HOST: ${FRONTEND_DOMAIN:?set FRONTEND_DOMAIN}
      LETSENCRYPT_HOST: ${FRONTEND_DOMAIN:?set FRONTEND_DOMAIN}
      VIRTUAL_PORT: 80
    networks:
      - proxy-tier

networks:
  backend:
    driver: bridge
  proxy-tier:
    external: true
